---
title: "Stat 230 HW 6"
author: "Name: Teagan Johnson"
output: pdf_document
---
```{r, include=FALSE}
knitr::opts_chunk$set(collapse=TRUE, prompt=FALSE, comment=NULL, warning = FALSE, message = FALSE)
```


### worked with: Parker Johnson, Miles Tisserand


Homework 6 is due **by 3pm Thursday, Oct. 4**. Please complete the assignment in this Markdown document, filling in your answers and R code below.  I didn't create answer and R chunk fields like I did with homework 1, but please fill in your answers and R code in the same manner as hw 1.  Submit  a hard copy of the **compiled pdf or word doc** either

  - in class 
  - in drop-in office hours 
  - in the paper holder outside my CMC 222 office door

Tips for using Markdown with homework sets:

- Work through a problem by putting your R code into R chunks in this .Rmd. Run the R code to make sure it works, then knit the .Rmd to verify they work in that environment.
    - Make sure you load your data in the .Rmd and include any needed `library` commands. 
- Feel free to edit or delete  questions, instructions, or code provided in this file when producing your homework solution. 
- For your final document, you can change the output type from `html_document` to `word_document` or `pdf_document`. These two to output types are better formatted for printing. 
  - on maize: you may need to allow for pop-ups from this site 
- If you want to knit to pdf while running Rstudio from your computer (*not* from maize), you  will need a LaTeX compiler installed on your computer. This could be [MiKTeX](https://miktex.org/), [MacTeX](http://www.tug.org/mactex/) (mac), or TinyTex. The latter is installed in R: first install the R package `tinytex`, then run the command `tinytex::install_tinytex()` to install this software. 
  - If you are using maize, you don't need to install anything to knit to pdf!


--------------------------------------------

## Problem 1:   Donner Ch.20 Exercise 9
Just use the estimated log odds model **given in this exercise** to answer the question "by hand" (*don't* fit the model in R and use the predict command). **Show all formulas and worked needed to derive your answers.** \

*Answer: * \
(a) \
The estimated probability of survival for 25 year old men is 0.7772999. \
The estimated probability of survival for 50 year old men is 0.3318122. \
The estimated probability of survival for 25 year old women is 0.4133824. \
The estimated probability of survival for 50 year old women is 0.09112296. \

(b) \
The age at which the estimated probability of survival is 50% for men is 41.025641025641. \
The age at which the estimated probability of survival is 50% for women is 20.5128205128205 \


```{r}
men25 <- 3.2-(.078*25)
men50 <- 3.2-(.078*50)

women25 <- 1.6-(.078*25)
women50 <- 1.6-(.078*50)

exp(men25) / (1 + exp(men25))
exp(men50) / (1 + exp(men50))
exp(women25) / (1 + exp(women25))
exp(women50) / (1 + exp(women50))

# .5 = exp(3.2 - (.078*x)) / (1 + exp(3.2 - (.078*x)))
```

---------------------------------------


## Problem 2: Donner interaction
A comment in section 20.6.1 suggests that there may be a weak interaction between sex and age in the donner data. Let's explore that further. The data for this example is `case2001`.

### (2a) Use `ggplot2` to create a boxplot of `Age` by `Status` that is faceted by `Sex`.  Explain why this graph is suggestive of a possible interactive effect of `Sex` and `Age`. \

*Answer: * \
It appears that males that died tend to be younger, while females that dies tend to be older. It also appears that the average age of males that survived is a bit higher than the average age of females that survived. We can conclude that there is a possible interactive effect between sex and age.

```{r}
library(Sleuth3)
donner <- case2001
#head(donner)
library(ggplot2)
ggplot(donner, aes(x = Status, y = Age)) + 
  geom_boxplot() + 
  coord_flip() +
  facet_wrap(~Sex)
```

### (2b) Fit the logistic regression of survival status on age, sex and the interaction of age and sex. Give the estimated effect for the interaction and the p-value (based on the Wald z test) for the interaction term. \

*Answer: * \
The estimated effect for the interaction is 7.986 with a correspoding p-value of 0.0295 This is statistically significant.

```{r}
donner_glm <- glm(Status ~ Age:Sex, 
                    family = binomial, 
                    data = donner)

summary(donner_glm)
effect <- 61.827 - 53.841
effect
```

### (2c) Conduct a drop-in-deviance test for the interaction term. Give the p-value for this test and compare it to the Wald test p-value. Does you conclusion about the significance of the interaction term change? Explain. (Moral: as noted in comment 1 on pages 616-617, you should trust the drop in deviance test more than the Wald test.) \

*Answer: * \
The p-value for this test is 0.048 which is greater than the Wald test but still statistically significant. My conclusion about the interaction term is the same since both p-values for the drop-in and the wald tests were statistically significant.

```{r}
donner_glm1 <- glm(Status ~ Age + Sex, 
                    family = binomial, 
                    data = donner)
donner_glm2 <- glm(Status ~ Age + Sex + Age:Sex, 
                    family = binomial, 
                    data = donner)

anova(donner_glm1, donner_glm2, test = "Chisq")

LRT <- 51.256 - 47.346
1-pchisq(LRT, 1)
```

### (2d) Using the regression of survival status on age, sex and the interaction of age and sex, what is the change in the odds of survival for a one year increase in age for females? Compute a 95% confidence interval for this effect. \

$logit(\pi) = 7.24638 - 0.19407age - 6.92805sexmale + 0.16160age:sexmale$ \
$odds(status | sex=female) = e^{7.24638 - 0.19407age - 6.92805sexmale + 0.16160agesexmale}$ \
$odds(status | sex=female, age=age+1) = e^{7.24638 - 0.19407(age+1) - 6.92805sexmale + 0.16160(age+1)sexmale}$ \
A one year increase in age for females results in a multiplicative change of $e^{-0.19407}=0.8236003$ on odds of survival \
The 95% CI for this change is $(0.6939121, 0.9775264)$.

```{r}
summary(donner_glm2)
exp(-0.19407)
100*(exp(-0.19407) - 1) # percent change
exp(-0.19407 + c(-1,1)*qnorm(0.975)*0.08742)
```


### (2e) Using the regression of survival status on age, sex and the interaction of age and sex, what is the change in the odds of survival for a one year increase in age for males? Compute a 95% confidence interval for this effect. Use this CI to determine if the effect of age on survival is statistically significant for men. (Hint: you are estimating the linear combination $\beta$'s so you will need to use the `vcov` command to compute your SE.) \

*Answer: * \
$logit(\pi) = 7.24638 - 0.19407age - 6.92805sexmale + 0.16160age:sexmale$ \
$odds(status | sex=male) = e^{7.24638 - 0.19407age - 6.92805sexmale + 0.16160age:sexmale}$ \
$odds(status | sex=male, age=age+1) = e^{7.24638 - 0.19407(age+1) - 6.92805sexmale + 0.16160(age+1):sexmale}$ \
A multiplicative change of $e^{-0.19407}e^{0.16160} = 0.9680515$ \
The 95% CI is $(0.9044076, 1.0384968)$ \



```{r}
exp(-0.19407)*exp(0.16160)
vcov(donner_glm2)
(sqrt(0.007641451 + 0.008885308 + 2*(1)*-0.007641451))
exp((-0.1940*0.16160) + (c(-1,1)*qnorm(0.975)*(sqrt(0.007641451 + 0.008885308 + 2*(1)*-0.007641451))))
```

### (2f) Compute and interpret the odds ratio for survival for females vs. males who are all 30 years old. Repeat this calculation and interpretation for females vs. males who are 40 years old.

*Answer: * \
$\frac{odds(status | sex=male, age=30)}{odds(status | sex=female, age=30)}$ \
$odds(status | sex=male, age=30) = e^{7.24638 - 0.19407(30) - 6.92805 + 0.16160(30)}$ \
$odds(status | sex=female, age=30) = e^{7.24638 - 0.19407(30)}$ \
$odds(status | sex=female, age=30) = 0.124924$ \
The odds ratio for females vs. males who are all 30 years old is 8.004869. This means that holding age constant at 30 years old, females have 8-fold higher odds to survive than males. \
The odds ratio for females vs. males who are all 40 years old is 1.590502 This means that holding age constant at 40 years old, females have 1.6-fold higher odds to survive than males. \

```{r}
odds_male_30 <- exp(7.24638 - 0.19407*(30) - 6.92805 + 0.16160*(30))
odds_female_30 <- exp(7.24638 - 0.19407*(30))
odds_female_30/odds_male_30

odds_male_40 <- exp(7.24638 - 0.19407*(40) - 6.92805 + 0.16160*(40))
odds_female_40 <- exp(7.24638 - 0.19407*(40))
odds_female_40/odds_male_40
```



---------------------------------------


## Problem 3:  Moose Sightability
The data file `sightability.csv` (linked [here](http://people.carleton.edu/~kstclair/data/sightability.csv)) contains data from sightability flights conducted by the Minnesota Department of Natural Resources (MN DNR) during 2005-2007 in northeastern Minnesota. Workers from the DNR would fly over a location that was known to contain a radio collared moose and they would record whether or not they observed the moose, or moose group, below them. This response is given by the variable *observed* with `1` indicating that they did see the moose and 0 indicating that they were unable to sight the moose. Their goal is to model the probability of sighting a moose during one fly over of the location. Along with this sight indicator, they also record  weather and ground cover characteristics that might affect their probability of sighting the moose. Some of these variables are: 

- `snowdepth` ($<8, 8-16, >16$ inches), 
- `wind` (wind speed in miles/hour), 
- `tempf` (temp in Farenheit), `cloud` (categorized % cloud cover), 
- `grpsize` (number of moose in the group containing the radio collared moose), 
- `voc` (visual obstruction cover given as a %), 
- `suco` (survey conditions good or marginal/poor). 

Group size is determined for all radio collared moose (sometimes with a second fly over), even if they weren't seen in the initial fly over that determined the `observed` status of the moose. `voc` is basically telling you how much vegatation was in the fly over area with more vegetation often making the moose harder to see by the observers in the plane. `suco` is a subjective measure that assesses light and shadow conditions for a given flight. The goal of this problem is to construct your own model that can be used to model the probability of sighting a moose.

(Why is this an interesting data set? The goal of these sightability flights is to give the MN DNR a model they can use during their annual winter moose surveys in northern Minnesota. These surveys are used to track the health and abundance of all moose in northern Minnesota, not just to track the radio collared moose. During this survey, pilots fly over randomly selected plots and count the number of moose that they sight, and measure  many of the explanatory variables measured in the sightability study. They then use the sightability model constructed from the radio collar study to adjust their survey counts to account for all the moose that they likely did not see due high voc, among other factors. Click [here](http://www.dnr.state.mn.us/moose/index.html) for more info about this research.)

```{r}
sight <- read.csv("http://people.carleton.edu/~kstclair/data/sightability.csv")
```

### (3a)  None of the quantitative variables need transformations. Verify this fact for the variable `voc` by computing the sample proportion and log odds for each level of voc (voc of $0, 5, 10, \dotsc, 95, 100$). Plot the sample log odds vs. the unique values of voc to verify that the plot is roughly linear (satisfying model logit linearity assumption). 

*Answer: * \
It is clear, looking at the log odds plot, that there is a linear relationship and that the constant variance assumption is withheld.

Hint: Since `voc` is a discrete measure, we can `group_by` it and compute the probability and log odds of success within each group. Use the `sight.logOdds` data frame to make your log odds plot:
```{r}
library(dplyr)
sight.logOdds <- sight %>%
  group_by(voc) %>% 
  summarize(prob = mean(observed), logOdds = log(prob/(1-prob)))
ggplot(sight.logOdds, aes(x=prob, y=logOdds)) + 
  geom_point()
```


### (3b)   Fit the regression of observed on snowdepth, wind, tempf, cloud, grpsize, voc, and suco. Test the significance of cloud cover in this model. \

*Answer: * \
The estimated efect of cloud cover in the model is 3.1 with a corresponding p-value of 0.5395889. This is statistically insignificant, so we can conclude that cloud cover does not significantly affect this model.

```{r}
sight_glm_cloud <- glm(observed ~ snowdepth + wind + tempf + cloud + grpsize + voc + suco, 
                    family = binomial, 
                    data = sight)
sight_glm <- glm(observed ~ snowdepth + wind + tempf + grpsize + voc + suco, 
                    family = binomial, 
                    data = sight)
anova(sight_glm, sight_glm_cloud, test = "Chisq")

LRT <- 139.80 - 136.69
1-pchisq(LRT, 4)
```


### (3c)  Starting with your part (b) model, use backwards selection to find the most significant predictors of sightability. You **do not(!)** need to check for assumptions or outliers. (The assumptions seem to be met and there are no unusually influential cases.) You **do** need to give a step-by-step description of your model selection, including hypotheses and p-values given at each step to justify the elimination of each variable you throw out. \

*Answer: * \
We can take out the cloud cover variable since we concluded that it was insignificant in part b. \
$H_0: ln(odds)=\beta_0 + \beta_1snowdepth + \beta_2wind + \beta_3tempf + \beta_4grpsize + \beta_5voc + \beta_6suco$ \
$H_A: ln(odds)=\beta_0 + \beta_2wind + \beta_3tempf + \beta_4grpsize + \beta_5voc + \beta_6suco$ \
The effect of snowdepth on observed moose is 3.11 with a corresponding p-value of 0.5395889. This is statistically insignificant, so we can take snowdepth from the model. \

$H_0: ln(odds)=\beta_0 + \beta_2wind + \beta_3tempf + \beta_4grpsize + \beta_5voc + \beta_6suco$ \
$H_A: ln(odds)=\beta_0 + \beta_3tempf + \beta_4grpsize + \beta_5voc + \beta_6suco$ \
The effect of wind on observed moose is 4.64 with a corresponding p-value of 0.3262683 This is statistically insignificant, so we can take wind from the model. \

$H_0: ln(odds)=\beta_0 + \beta_3tempf + \beta_4grpsize + \beta_5voc + \beta_6suco$ \
$H_A: ln(odds)=\beta_0 + \beta_4grpsize + \beta_5voc + \beta_6suco$ \
The effect of tempf on observed moose is 4.05 with a corresponding p-value of 0.5422399 This is statistically insignificant, so we can take tempf from the model. \

$H_0: ln(odds)=\beta_0 + \beta_4grpsize + \beta_5voc + \beta_6suco$ \
$H_A: ln(odds)=\beta_0 + \beta_5voc + \beta_6suco$ \
The effect of grpsize on observed moose is 1.38 with a corresponding p-value of 0.2401011 This is statistically insignificant, so we can take grpsize from the model. \

$H_0: ln(odds)=\beta_0 + \beta_5voc + \beta_6suco$ \
$H_A: ln(odds)=\beta_0 + \beta_5voc$ \
The effect of suco on observed moose is 2.78 with a corresponding p-value of 0.09544817 This is statistically insignificant, so we can take suco from the model. \


$H_0: ln(odds)=\beta_0 + \beta_5voc$ \
$H_A: ln(odds)=\beta_0$ \
The effect of voc on observed moose is -0.034792 with a corresponding p-value of 7.21e-06 This is statistically significant, so we can't take voc from the model. So our final model is just observed on voc. \

```{r}
sight_glm_large <- glm(observed ~ voc, 
                    family = binomial, 
                    data = sight)
summary(sight_glm_large)

```

### (3d) The MN DNR concluded that voc is the most important predictor of sightability (if your results for part (c) disagree, you may want to redo your model selection!). Use your ``best" model from part (c) to determine how increasing voc by 5 percentage points will effect the odds of sighting a moose. Also give a 95% confidence interval for this effect. \

*Answer: * \
$odds(observed | voc=voc+1) = e^{1.759933 - 0.034792(voc+5)}$ \
The estimated effect of increasing voc by 5 percentage has a multiplicative change of $e^{-0.034792(5)}$ on the odds of sighting a moose. In other words, it has a 15% decrease on the odds of seeing a moose.

```{r}
exp(-0.034792*(5))
```




-------------------------------------

## Problem 4: Tire failure on Ford Explorers (ch. 20 exercise 18) 
Read the data set description for exercise 18, then use the data provided  (`ex2018`) to answer the following questions.


### (4a)  The textbook also suggests an interaction between vehicle type (`Make`) and number of `Passengers`. To explore this interaction, create a side-by-side boxplot of `Passengers` by `Cause` that is faceted by `Make`. Carefully explain why this graph suggests that we should add the interaction between vehicle type and number of Passengers in the model for odds of tire failure.

*Answer: * \
It appears that the number of passengers in Ford models is on average greater than the number of passengers in other models. Therefore, we can say that there is a potential relationship between vehicle type and the number of passengers.

```{r}
tire <- ex2018
head(tire)
ggplot(tire, aes(x = Cause, y = Passengers)) + 
  geom_boxplot() + 
  coord_flip() +
  facet_wrap(~Make)
```

### (4b)  Fit the logistic regression of cause on age, age$^2$, number of passengers, vehicle make, and the interaction of passengers and make. Write down the fitted equation for Fords and non-Ford vehicles.

*Answer: * \
$logi(other) = -10.8475 + 3.4212vehicleage - 0.3961vehicleage^2 + 0.8393passengers - 1.5322other - 0.6360passengers:makeother$ \
$logi(Ford) = -10.8475 + 3.4212vehicleage - 0.3961vehicleage^2 + 0.8393passengers - 0.6360passengers:makeother$ \

```{r}
tire_glm <- glm(Cause ~ VehicleAge + I(VehicleAge^2) + Passengers + Make + Passengers:Make, 
                    family = binomial, 
                    data = tire)
summary(tire_glm)
```

### (4c)  What is the effect of vehicle type on the odds of tire failure? Give your answer as an odds ratio formula involving model cofficient estimates and the variable passengers. Clearly state what the odds ratio is measuring (odds of ? for group ? vs. ?). (Note: this answer will be an equation involving passengers. You will get actual odds ration numbers in part d.) \

*Answer: * \
This odds ratio says that accounting for age, the ratio of odds of a tire accident in an "other" model is $e^{-1.53-.636Passengers}$ times the probability of a tire accident in a Ford. 

$\frac{odds(type=other)}{odds(type=Ford)}$ \

where \

$odds(type=Ford) = e^{-10.8475 + 3.42age - 0.396age^2 + 0.8393passengers}$ \
$odds(type=other) = e^{-10.8475 + .203passengers - 0.6360 - 0.396age^2}$ \

So we have $e^{-1.53-.636Passengers}$ \

This odds ratio is measuring the odds of tire failure for Ford models vs. other models. \


### (4d) Compute the odds ratio from part (c) for passenger levels of 0, 1, 2, 3, and 4 passengers. Explain what these odds ratios tell you about tire-related accidents, vehicle type and number of passengers.

*Answer: * \

These odds ratios compare the odds of a tire accident in "other" models vs. Ford models for a fixed number of passengers in the car. For example, when there are 3 people in the car, the odds of having a tire accident in an "other" type is 0.03212888 times the odds of having an accident in a Ford. Ultimately, the odds of a tire accident continue increasing in a Ford as the number of passengers increases. \

$e^{-1.53} = 0.2165357$ \
$e^{-1.53 -.636} = 0.1146352$ \
$e^{-1.53 -.636(2)} = 0.06068856$ \
$e^{-1.53 -.636(3)} = 0.03212888$ \
$e^{-1.53 -.636(4)} = 0.01700922$ \

```{r}
exp(-1.53)
exp(-1.53 - .636*1)
exp(-1.53 - .636*2)
exp(-1.53 - .636*3)
exp(-1.53 - .636*4)
```

